<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Self-Dev RPG v6 — Dynamic EXP + PWA</title>
  <link rel="manifest" href="/power/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Self-Dev RPG">
  <link rel="apple-touch-icon" href="/power/icons/icon-192.png">
  <style>
    :root{--bg:#0b0f14;--card:#121922;--muted:#8aa0b3;--text:#e9f0f7;--acc:#61c0ff;--acc2:#58e38b;--warn:#ff7b72;--amber:#ffd166;}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1000px 400px at 50% -20%,rgba(97,192,255,.12),transparent),#0b0f14;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(180%) blur(8px);background:rgba(11,15,20,.7);border-bottom:1px solid #1d2733}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px}
    .tag{font-size:12px;border:1px solid #263445;background:#111826;padding:3px 8px;border-radius:999px;color:#a6bed1}
    main{max-width:1200px;margin:18px auto;display:grid;grid-template-columns:1.1fr .9fr;gap:16px;padding:0 12px}
    @media (max-width:1000px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1d2733;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:none;border-radius:12px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--acc),#6be0ff);color:#001018;transition:.15s transform ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#1a2430;color:#d7e6f3}
    .btn.ghost{background:transparent;border:1px solid #2a3949;color:#bcd0df}
    .btn.warn{background:var(--warn);color:#210707}
    input,select{background:#0f151d;border:1px solid #263445;color:var(--text);padding:10px 12px;border-radius:12px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#0f151d;border:1px solid #223146;border-radius:14px;padding:12px}
    .kpi .v{font-size:22px;font-weight:800}
    .bar{height:14px;background:#0a0f14;border:1px solid #243242;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,#61c0ff,#58e38b);width:0}
    .mini{font-size:12px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){.grid2{grid-template-columns:1fr}}
    .list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto}
    .pill{font-size:11px;background:#0f151d;border:1px solid #243242;color:#a8becf;padding:3px 8px;border-radius:999px}
    .badge{display:inline-block;font-size:12px;border:1px solid #2a3949;background:#101822;color:#cfe6f7;padding:4px 8px;border-radius:999px}
    .activity{display:flex;align-items:center;gap:10px;background:#101825;border:1px solid #223146;padding:10px;border-radius:12px}
    .xp{font-weight:800;color:var(--acc2)}
    canvas{width:100%;height:220px;background:#0b0f14;border:1px solid #223146;border-radius:12px}
    .sectionTitle{margin:0 0 8px;font-size:18px;font-weight:800;letter-spacing:.2px}
    .talent{background:#101825;border:1px solid #223146;border-radius:12px;padding:12px}
    .talent .name{font-weight:800}
    .talent .meta{font-size:12px;color:#a3bbcf}
    .skills{display:flex;gap:10px;flex-wrap:wrap}
    .skill{background:#101825;border:1px solid #223146;border-radius:12px;padding:10px;min-width:150px}
    .skill.disabled{opacity:.55}
    .statbar{height:12px;background:#0a0f14;border:1px solid #223146;border-radius:10px;overflow:hidden}
    .statbar > span{display:block;height:100%;background:linear-gradient(90deg,#61c0ff,#58e38b);width:0}
    .bossSvg{width:160px;height:120px;border:1px solid #223146;border-radius:12px;background:#0b0f14}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .sheet{background:#0f151d;border:1px solid #223146;border-radius:16px;max-width:520px;width:92%;padding:16px}
    .sheet h3{margin:0 0 8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <h1>Self‑Dev RPG <span class="tag">v6</span></h1>
      <div class="row" style="gap:8px">
        <span class="pill">오프라인 지원</span>
        <span class="pill">자기보고형 EXP</span>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="sectionTitle">대시보드</div>
      <div class="kpis">
        <div class="kpi"><div class="mini">레벨</div><div class="v" id="levelVal">1</div></div>
        <div class="kpi"><div class="mini">총 XP</div><div class="v" id="xpVal">0</div></div>
        <div class="kpi"><div class="mini">오늘 XP</div><div class="v" id="todayVal">0</div></div>
        <div class="kpi"><div class="mini">스트릭</div><div class="v" id="streakVal">0</div></div>
        <div class="kpi"><div class="mini">SP</div><div class="v" id="spVal">0</div></div>
      </div>
      <div class="mini" style="margin:10px 0 6px">레벨 진행도</div>
      <div class="bar"><span id="progress"></span></div>
      <div class="row" style="margin-top:10px">
        <span class="pill">감소: <span id="decayRateTxt"></span>/h</span>
        <span class="pill">목표: <span id="goalTxt"></span></span>
        <span class="pill">소프트캡: <span id="capTxt"></span></span>
        <button class="btn secondary" id="decayNow" style="flex:0 0 auto">지금 감소</button>
        <button class="btn warn" id="hardReset" style="flex:0 0 auto">초기화</button>
      </div>
      <div class="mini" id="xpBuffInfo">경험치 버프: 없음</div>
      <div class="mini" style="margin-top:6px">하드코어: 3일 연속 미달 → <b>레벨 다운</b> · 7일 중 5일 달성 → <b>유물</b></div>
    </section>

    <section class="card">
      <div class="sectionTitle">설정</div>
      <div class="grid2">
        <div class="row">
          <label class="mini">레벨 곡선</label>
          <select id="curveSel">
            <option value="quad" selected>제곱형 (100·L²)</option>
            <option value="lin">선형형 (100·L)</option>
            <option value="exp">지수형 (~1.4^L)</option>
          </select>
        </div>
        <div class="row"><label class="mini">감소(시간당)</label><input type="number" id="decayPerHour" value="4" min="0"></div>
        <div class="row"><label class="mini">하루 목표</label><input type="number" id="dailyGoal" value="180" min="0"></div>
        <div class="row"><label class="mini">일간 소프트캡</label><input type="number" id="dailyCap" value="480" min="0"></div>
      </div>
      <div class="row" style="margin-top:8px"><button class="btn" id="saveCfg" style="flex:0 0 auto">저장</button></div>
    </section>

    <section class="card">
      <div class="sectionTitle">활동 기록 — 자유 입력</div>
      <div class="row">
        <button class="btn" id="openCalc" style="flex:0 0 auto">계산식으로 기록</button>
        <button class="btn ghost" id="openFree" style="flex:0 0 auto">직접 XP 입력</button>
        <span class="badge" id="todayBadge">오늘: 0</span>
      </div>
      <div class="list" id="logList" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <div class="sectionTitle">보스전</div>
      <div class="mini" id="bossHint">오늘 최다 카테고리에 보스 약점(+15%).</div>
      <div class="row" style="align-items:flex-start">
        <svg id="bossSvg" class="bossSvg" viewBox="0 0 160 120"></svg>
        <div style="flex:1">
          <div class="mini">플레이어 HP</div><div class="statbar"><span id="pHP"></span></div><div class="mini" id="pHPtxt"></div>
          <div class="mini" style="margin-top:6px">보스 HP</div><div class="statbar"><span id="bHP"></span></div><div class="mini" id="bHPtxt"></div>
        </div>
      </div>
      <div class="skills" id="skills" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="startBoss" style="flex:0 0 auto">보스 소환</button>
        <span class="pill" id="bossName">보스: 없음</span>
        <span class="pill" id="bossInfo">-</span>
      </div>
      <div class="card" style="margin-top:10px;background:#0f151d"><div class="mini">전투 기록</div><div id="combatLog" class="mini" style="white-space:pre-line;max-height:180px;overflow:auto"></div></div>
    </section>

    <section class="card">
      <div class="sectionTitle">스킬 트리</div>
      <div id="talentGrid" class="grid2"></div>
      <div class="row" style="margin-top:10px">
        <span class="pill">보유 SP: <b id="spBadge">0</b></span>
        <button class="btn secondary" id="resetTalents" style="flex:0 0 auto">특성 초기화</button>
      </div>
    </section>

    <section class="card">
      <div class="sectionTitle">추이</div>
      <canvas id="chart" width="1200" height="240"></canvas>
    </section>
  </main>

  <!-- Calculator Modal -->
  <div class="modal" id="modalCalc">
    <div class="sheet">
      <h3>계산식으로 기록</h3>
      <div class="row">
        <select id="calcType">
          <option value="study">공부</option>
          <option value="workout">운동</option>
          <option value="meditation">명상</option>
          <option value="reading">독서</option>
          <option value="project">프로젝트</option>
          <option value="journaling">저널링/글쓰기</option>
          <option value="routine">루틴 유지</option>
        </select>
        <input id="metric" type="number" placeholder="수치(분/페이지/문단/%)" min="0">
        <select id="intensity">
          <option value="1">강도/집중 1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="calcCat">
          <option value="mind">지적 성장</option>
          <option value="body">신체 성장</option>
          <option value="spirit">정신 안정</option>
          <option value="create">창조 활동</option>
          <option value="social">사회 관계</option>
          <option value="reflect">자기 성찰</option>
          <option value="system">관리</option>
          <option value="finance">재정</option>
          <option value="persona">자기 표현</option>
          <option value="recovery">회복</option>
        </select>
        <input id="memo" placeholder="메모(선택)"/>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <button class="btn ghost" id="closeCalc" style="flex:0 0 auto">닫기</button>
        <button class="btn" id="calcSubmit" style="flex:0 0 auto">XP 기록</button>
      </div>
      <div class="mini" style="margin-top:8px">예) 공부 120분 · 집중 4 → 자동 계산</div>
    </div>
  </div>

  <!-- Free Modal -->
  <div class="modal" id="modalFree">
    <div class="sheet">
      <h3>직접 XP 입력</h3>
      <div class="row">
        <input id="freeName" placeholder="활동 이름(예: 마케팅 분석)"/>
        <select id="freeCat">
          <option value="mind">지적 성장</option>
          <option value="body">신체 성장</option>
          <option value="spirit">정신 안정</option>
          <option value="create">창조 활동</option>
          <option value="social">사회 관계</option>
          <option value="reflect">자기 성찰</option>
          <option value="system">관리</option>
          <option value="finance">재정</option>
          <option value="persona">자기 표현</option>
          <option value="recovery">회복</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="freeXP" type="number" placeholder="XP (직접 입력)" min="0"/>
        <input id="freeMemo" placeholder="메모(선택)"/>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <button class="btn ghost" id="closeFree" style="flex:0 0 auto">닫기</button>
        <button class="btn" id="freeSubmit" style="flex:0 0 auto">XP 기록</button>
      </div>
    </div>
  </div>

  <script>
    const storeKey = 'sdrpg_v6';
    const nowTs = ()=> Date.now();
    const dayKey = t => new Date(t).toISOString().slice(0,10);
    const clamp = (x,a,b)=> Math.min(b, Math.max(a,x));
    const $ = (id)=>document.getElementById(id);
    const store = { get(){ try{return JSON.parse(localStorage.getItem(storeKey)||'{}')}catch(e){return {}} }, set(d){ localStorage.setItem(storeKey, JSON.stringify(d)); } };
    const defaults = { xp:0, lastUpdate:nowTs(), lastActivityDay:dayKey(nowTs()), lastLevel:1, sp:0, streak:0, missStreak:0, weeklyHits:{}, history:{}, daily:{}, badges:[], cfg:{curve:'quad', decayPerHour:4, dailyGoal:180, dailyCap:480}, talents:{}, passives:{decayDown:0,capUp:0,metaBonus:0,xpGlobal:0, bossAtkUp:0,critUp:0,cdReduce:0}, inventory:{}, xpBuffUntil:0, __prevDay: dayKey(nowTs()) };
    let state = init(); function init(){ let d=store.get(); if(!Object.keys(d).length){ store.set(defaults); d=defaults; } d.cfg={...defaults.cfg, ...(d.cfg||{})}; d.__prevDay ||= dayKey(nowTs()); store.set(d); return d; }
    function levelFromXP(xp, curve){ if(curve==='lin'){const L=Math.max(1,Math.floor(xp/100)+1);return {L,prevAt:(L-1)*100,nextAt:L*100};} if(curve==='exp'){let L=1,next=120,acc=0;while(acc+next<=xp&&L<200){acc+=next;L++;next=Math.round(next*1.4);}return {L,prevAt:acc,nextAt:acc+next};} let L=1;while(100*(L**2)<=xp&&L<999){L++;}return {L,prevAt:100*((L-1)**2),nextAt:100*(L**2)}; }
    const GOAL_BONUS=0.2, INACTIVITY=20, SOFTCAP_RATE=0.5;
    function applyDecay(){ const d=store.get(); const now=nowTs(); const hours=(now-(d.lastUpdate||now))/3600000; const dec=Math.max(0, hours*(d.cfg.decayPerHour||0)*(1-0.1*(d.passives.decayDown||0))); d.xp=Math.max(0,d.xp-dec); d.lastUpdate=now; store.set(d); state=d; }
    function ensureDay(k){ const d=store.get(); d.daily[k]=d.daily[k]||{total:0,catTotals:{},logs:0}; store.set(d); return d.daily[k]; }
    function endOfDayProcess(k){ const d=store.get(); const day=d.daily[k]||{total:0,logs:0}; const goal=d.cfg.dailyGoal||180; const meta=(d.passives.metaBonus||0)*0.05; if(day.total>=goal){ d.xp+=goal*(GOAL_BONUS+meta); d.weeklyHits[k]=true; d.missStreak=0; } else { d.missStreak=(d.missStreak||0)+1; if(day.logs===0) d.xp=Math.max(0,d.xp-INACTIVITY); if(d.missStreak>=3){ const L=levelFromXP(d.xp,d.cfg.curve); const lower=L.L>2?levelFromXP(L.prevAt-1,d.cfg.curve).prevAt:0; d.xp=Math.max(lower,L.prevAt); d.missStreak=0; } } d.history[k]=Math.round(d.xp); store.set(d); state=d; }
    function backfill(){ const d=store.get(); let cur=d.__prevDay||dayKey(nowTs()); const today=dayKey(nowTs()); let guard=0; while(cur<today && guard<35){ endOfDayProcess(cur); cur=dayKey(new Date(cur).getTime()+86400000); guard++; } d.__prevDay=today; store.set(d); state=d; }
    function calcXP(type, metric, intensity=1){ const m=Number(metric||0), i=Number(intensity||1); const rules={study:(m/10)*i*2, workout:(m/8)*i*2, meditation:(m/5)*1.5, reading:(m/5), project:(m/10)*5, journaling:(m*8), routine:20}; return Math.round(rules[type]||0); }
    const CAT_MULT={mind:1.10, body:1.08, spirit:1.05, create:1.12, social:1.07, reflect:1.15, system:1.05, finance:1.06, persona:1.08, recovery:1.05};
    function applyXP(cat, baseXP){ applyDecay(); const d=store.get(); const today=dayKey(nowTs()); const day=ensureDay(today); let xp=baseXP*(CAT_MULT[cat]||1); const cap=(d.cfg.dailyCap||480)+50*(d.passives.capUp||0); const room=Math.max(0,cap-day.total); if(xp>room) xp=room+(xp-room)*SOFTCAP_RATE; d.xp+=xp; day.total+=xp; day.catTotals[cat]=(day.catTotals[cat]||0)+xp; day.logs++; if(d.lastActivityDay!==today){ const y=dayKey(Date.now()-86400000); d.streak=(d.lastActivityDay===y)?(d.streak||0)+1:1; d.lastActivityDay=today; } d.history[today]=Math.round(d.xp); store.set(d); state=d; renderAll(); alert('+'+Math.round(xp)+' XP'); }
    function renderKPIs(){ applyDecay(); const d=store.get(); const L=levelFromXP(d.xp,d.cfg.curve); $('#levelVal').textContent=L.L; $('#xpVal').textContent=Math.round(d.xp); $('#streakVal').textContent=d.streak||0; $('#spVal').textContent=d.sp||0; const today=dayKey(Date.now()); const day=ensureDay(today); $('#todayVal').textContent=Math.round(day.total); $('#todayBadge').textContent='오늘: '+Math.round(day.total)+' / 목표 '+d.cfg.dailyGoal; $('#decayRateTxt').textContent=d.cfg.decayPerHour; $('#goalTxt').textContent=d.cfg.dailyGoal; $('#capTxt').textContent=d.cfg.dailyCap; document.getElementById('progress').style.width = Math.max(3,Math.min(100,Math.round(100*(d.xp-L.prevAt)/Math.max(1,L.nextAt-L.prevAt))))+'%'; }
    function renderLogs(){ const d=store.get(); const list=$('logList'); const today=dayKey(Date.now()); const day=d.daily[today]||{catTotals:{}}; list.innerHTML=''; const cats=Object.keys(day.catTotals); if(!cats.length){ list.innerHTML='<div class="mini">아직 기록 없음</div>'; return;} cats.forEach(k=>{ const el=document.createElement('div'); el.className='activity'; el.innerHTML='<div style="flex:1"><b>'+k+'</b><div class="mini">오늘 누적: <span class="xp">'+Math.round(day.catTotals[k])+' XP</span></div></div>'; list.appendChild(el); }); }
    function chart(){ const c=document.getElementById('chart'); const x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height); const days=[]; for(let i=29;i>=0;i--) days.push(dayKey(Date.now()-i*86400000)); const vals=days.map(k=>store.get().history[k]||0); const pad=28,w=c.width,h=c.height; x.strokeStyle='#223146'; for(let i=0;i<=4;i++){const y=pad+(h-2*pad)*(i/4); x.beginPath(); x.moveTo(pad,y); x.lineTo(w-pad,y); x.stroke();} const max=Math.max(100,...vals); x.beginPath(); vals.forEach((v,i)=>{const X=pad+(w-2*pad)*(i/(vals.length-1)); const Y=h-pad-(h-2*pad)*(v/max); if(i===0)x.moveTo(X,Y); else x.lineTo(X,Y);}); x.strokeStyle='#61c0ff'; x.lineWidth=2; x.stroke(); }
    function renderAll(){ renderKPIs(); renderLogs(); chart(); }
    document.getElementById('openCalc').onclick=()=>{$('modalCalc').style.display='flex'}; document.getElementById('closeCalc').onclick=()=>{$('modalCalc').style.display='none'};
    document.getElementById('openFree').onclick=()=>{$('modalFree').style.display='flex'}; document.getElementById('closeFree').onclick=()=>{$('modalFree').style.display='none'};
    document.getElementById('calcSubmit').onclick=()=>{ const xp=calcXP(document.getElementById('calcType').value, document.getElementById('metric').value, document.getElementById('intensity').value); const cat=document.getElementById('calcCat').value; applyXP(cat, ((store.get().xpBuffUntil||0)>nowTs())?xp*1.2:xp); document.getElementById('modalCalc').style.display='none'; };
    document.getElementById('freeSubmit').onclick=()=>{ const name=document.getElementById('freeName').value.trim(); const cat=document.getElementById('freeCat').value; const xp=Number(document.getElementById('freeXP').value||0); if(!name||!Number.isFinite(xp)) return alert('이름/XP 확인'); applyXP(cat, xp); document.getElementById('modalFree').style.display='none'; document.getElementById('freeName').value=''; document.getElementById('freeXP').value=''; };
    document.getElementById('saveCfg').onclick=()=>{ const d=store.get(); d.cfg.curve=document.getElementById('curveSel').value; d.cfg.decayPerHour=Number(document.getElementById('decayPerHour').value)||0; d.cfg.dailyGoal=Number(document.getElementById('dailyGoal').value)||0; d.cfg.dailyCap=Number(document.getElementById('dailyCap').value)||0; store.set(d); state=d; renderAll(); };
    document.getElementById('decayNow').onclick=()=>{applyDecay(); renderAll();};
    document.getElementById('hardReset').onclick=()=>{ if(!confirm('모든 데이터를 초기화합니다.')) return; localStorage.removeItem(storeKey); state=init(); renderAll(); };
    setInterval(()=>{ const prev=state.__prevDay||dayKey(Date.now()); applyDecay(); const today=dayKey(Date.now()); if(today!==prev){ endOfDayProcess(prev); state.__prevDay=today; store.set(state);} renderAll(); }, 60000);
    backfill(); renderAll();
    if('serviceWorker' in navigator){ addEventListener('load', async ()=>{ try{ await navigator.serviceWorker.register('/power/service-worker.js',{scope:'/power/'});}catch(e){} }); }
  </script>
</body>
</html>